@model Cedeva.Website.Features.ActivityManagement.ViewModels.PresencesViewModel

@{
    ViewData["Title"] = Localizer["Presences"] + " - " + Model.Activity.Name;
}

<div class="container-fluid py-4">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <div>
            <h2 class="mb-1">@Model.Activity.Name</h2>
            <p class="text-muted mb-0">@Localizer["ActivityManagement.ManagePresences"]</p>
        </div>
        <a asp-action="Index" asp-route-id="@Model.Activity.Id" class="btn btn-outline-secondary">
            <i class="fas fa-arrow-left"></i> @Localizer["BackToDashboard"]
        </a>
    </div>

    @if (TempData["SuccessMessage"] != null)
    {
        <div class="alert alert-success alert-dismissible fade show" role="alert">
            @TempData["SuccessMessage"]
            <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
        </div>
    }

    @if (TempData["ErrorMessage"] != null)
    {
        <div class="alert alert-danger alert-dismissible fade show" role="alert">
            @TempData["ErrorMessage"]
            <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
        </div>
    }

    <!-- Sélection du jour -->
    <div class="card mb-4">
        <div class="card-body">
            <form asp-action="Presences" method="get" class="row g-3 align-items-end">
                <input type="hidden" name="id" value="@Model.Activity.Id" />
                <div class="col-md-6">
                    <label for="dayId" class="form-label fw-bold">@Localizer["ActivityManagement.SelectDay"]</label>
                    <select name="dayId" id="dayId" class="form-select" onchange="this.form.submit()">
                        @if (!Model.ActivityDayOptions.Any())
                        {
                            <option value="">@Localizer["ActivityManagement.NoActiveDay"]</option>
                        }
                        else
                        {
                            @foreach (var option in Model.ActivityDayOptions)
                            {
                                <option value="@option.Value" selected="@option.Selected">@option.Text</option>
                            }
                        }
                    </select>
                </div>
                @if (Model.SelectedActivityDayId.HasValue)
                {
                    <div class="col-md-6 text-end">
                        <a asp-action="Print" asp-route-activityId="@Model.Activity.Id" asp-route-dayId="@Model.SelectedActivityDayId"
                           class="btn btn-secondary" target="_blank">
                            <i class="fas fa-print me-2"></i>@Localizer["Presence.PrintList"]
                        </a>
                    </div>
                }
            </form>
        </div>
    </div>

    @if (Model.SelectedActivityDay != null)
    {
        @if (!Model.ChildrenByGroup.Any())
        {
            <div class="alert alert-info">
                <i class="fas fa-info-circle"></i> @Localizer["ActivityManagement.NoConfirmedBookings"]
            </div>
        }
        else
        {
            <!-- Affichage par groupe -->
            @foreach (var groupEntry in Model.ChildrenByGroup)
            {
                var group = groupEntry.Key;
                var children = groupEntry.Value;

                <div class="card mb-4">
                    <div class="card-header bg-primary text-white">
                        <h5 class="mb-0">
                            <i class="fas fa-users"></i> @group.Label
                            <span class="badge bg-light text-dark ms-2">@children.Count @Localizer["ActivityManagement.ChildrenCount"]</span>
                        </h5>
                    </div>
                    <div class="card-body p-0">
                        <div class="table-responsive">
                            <table class="table table-hover mb-0">
                                <thead class="table-light">
                                    <tr>
                                        <th>@Localizer["LastName"]</th>
                                        <th>@Localizer["FirstName"]</th>
                                        <th class="text-center">@Localizer["Reserved"]</th>
                                        <th class="text-center">@Localizer["Present"]</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    @foreach (var child in children)
                                    {
                                        <tr class="@(child.IsPresent ? "table-success" : "")">
                                            <td>@child.ChildLastName</td>
                                            <td>@child.ChildFirstName</td>
                                            <td class="text-center">
                                                @if (child.IsReserved)
                                                {
                                                    <i class="fas fa-check text-success"></i>
                                                }
                                                else
                                                {
                                                    <i class="fas fa-times text-danger"></i>
                                                }
                                            </td>
                                            <td class="text-center">
                                                @if (child.BookingDayId.HasValue)
                                                {
                                                    <div class="form-check d-inline-block">
                                                        <input type="checkbox"
                                                               class="form-check-input presence-checkbox"
                                                               data-bookingday-id="@child.BookingDayId.Value"
                                                               @(child.IsPresent ? "checked" : "")
                                                               style="cursor: pointer;" />
                                                    </div>
                                                }
                                                else
                                                {
                                                    <span class="text-muted">N/A</span>
                                                }
                                            </td>
                                        </tr>
                                    }
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            }
        }
    }
    else
    {
        <div class="alert alert-warning">
            <i class="fas fa-exclamation-triangle"></i> @Localizer["ActivityManagement.SelectActivityDay"]
        </div>
    }
</div>

@section Scripts {
    @Html.AntiForgeryToken()
    <script>
        $(document).ready(function () {
            $('.presence-checkbox').on('change', function () {
                var checkbox = $(this);
                var bookingDayId = checkbox.data('bookingday-id');
                var isPresent = checkbox.is(':checked');
                var row = checkbox.closest('tr');

                // Récupérer le token anti-forgery
                var token = $('input[name="__RequestVerificationToken"]').val();

                $.ajax({
                    url: '@Url.Action("UpdatePresence", "ActivityManagement")',
                    type: 'POST',
                    headers: {
                        'RequestVerificationToken': token
                    },
                    data: {
                        bookingDayId: bookingDayId,
                        isPresent: isPresent
                    },
                    success: function (response) {
                        if (response.success) {
                            // Ajouter/retirer la classe table-success
                            if (isPresent) {
                                row.addClass('table-success');
                            } else {
                                row.removeClass('table-success');
                            }
                        } else {
                            alert('@Localizer["Error"]: ' + response.message);
                            // Rétablir l'état précédent
                            checkbox.prop('checked', !isPresent);
                        }
                    },
                    error: function () {
                        alert('@Localizer["ActivityManagement.UpdateError"]');
                        // Rétablir l'état précédent
                        checkbox.prop('checked', !isPresent);
                    }
                });
            });
        });
    </script>
}
