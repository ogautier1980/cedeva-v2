@model Cedeva.Website.Features.Activities.ViewModels.ActivityViewModel
@{
    ViewData["Title"] = Localizer["Activities.EditActivity"];
}

<div class="container-fluid">
    <div class="row">
        <div class="col-lg-8">
            <div class="card shadow">
                <div class="card-header">
                    <h5 class="mb-0"><i class="fas fa-edit me-2"></i>@Localizer["Activities.EditActivity"]</h5>
                </div>
                <div class="card-body">
                    @if (TempData["Warning"] != null)
                    {
                        <div class="alert alert-warning">
                            <i class="fas fa-exclamation-triangle me-2"></i>@TempData["Warning"]
                            <div class="mt-3">
                                <form asp-action="Edit" method="post">
                                    <input type="hidden" asp-for="Id" />
                                    <input type="hidden" asp-for="Name" />
                                    <input type="hidden" asp-for="Description" />
                                    <input type="hidden" asp-for="IsActive" />
                                    <input type="hidden" asp-for="PricePerDay" />
                                    <input type="hidden" asp-for="StartDate" />
                                    <input type="hidden" asp-for="EndDate" />
                                    <input type="hidden" asp-for="OrganisationId" />
                                    <input type="hidden" asp-for="IncludedPostalCodes" />
                                    <input type="hidden" asp-for="ExcludedPostalCodes" />
                                    @if (TempData["ActiveDaysAfterDeactivation"] != null)
                                    {
                                        var activeDayIds = TempData["ActiveDaysAfterDeactivation"]!.ToString()!.Split(',');
                                        foreach (var dayId in activeDayIds)
                                        {
                                            <input type="hidden" name="ActiveDayIds" value="@dayId" />
                                        }
                                    }
                                    <input type="hidden" name="removeDaysConfirmed" value="true" />
                                    <button type="submit" class="btn btn-danger">
                                        <i class="fas fa-check me-2"></i>@Localizer["Activities.ConfirmRemoveDays"]
                                    </button>
                                    <a asp-action="Edit" asp-route-id="@Model.Id" class="btn btn-secondary">
                                        <i class="fas fa-times me-2"></i>@Localizer["Cancel"]
                                    </a>
                                </form>
                            </div>
                        </div>
                    }

                    @if (TempData["Info"] != null)
                    {
                        <div class="alert alert-info">
                            <i class="fas fa-info-circle me-2"></i>@TempData["Info"]
                            <p class="mt-2 mb-2">@Localizer["Activities.AddDaysToBookingsQuestion"]</p>
                            <div class="mt-3">
                                <form asp-action="Edit" method="post" class="d-inline">
                                    <input type="hidden" asp-for="Id" />
                                    <input type="hidden" asp-for="Name" />
                                    <input type="hidden" asp-for="Description" />
                                    <input type="hidden" asp-for="IsActive" />
                                    <input type="hidden" asp-for="PricePerDay" />
                                    <input type="hidden" asp-for="StartDate" />
                                    <input type="hidden" asp-for="EndDate" />
                                    <input type="hidden" asp-for="OrganisationId" />
                                    <input type="hidden" asp-for="IncludedPostalCodes" />
                                    <input type="hidden" asp-for="ExcludedPostalCodes" />
                                    @foreach (var day in Model.AllDays)
                                    {
                                        @if (day.IsActive)
                                        {
                                            <input type="hidden" name="ActiveDayIds" value="@day.DayId" />
                                        }
                                    }
                                    <input type="hidden" name="addDaysToBookings" value="true" />
                                    <button type="submit" class="btn btn-success">
                                        <i class="fas fa-check me-2"></i>@Localizer["Yes"]
                                    </button>
                                </form>
                                <form asp-action="Edit" method="post" class="d-inline">
                                    <input type="hidden" asp-for="Id" />
                                    <input type="hidden" asp-for="Name" />
                                    <input type="hidden" asp-for="Description" />
                                    <input type="hidden" asp-for="IsActive" />
                                    <input type="hidden" asp-for="PricePerDay" />
                                    <input type="hidden" asp-for="StartDate" />
                                    <input type="hidden" asp-for="EndDate" />
                                    <input type="hidden" asp-for="OrganisationId" />
                                    <input type="hidden" asp-for="IncludedPostalCodes" />
                                    <input type="hidden" asp-for="ExcludedPostalCodes" />
                                    @foreach (var day in Model.AllDays)
                                    {
                                        @if (day.IsActive)
                                        {
                                            <input type="hidden" name="ActiveDayIds" value="@day.DayId" />
                                        }
                                    }
                                    <input type="hidden" name="addDaysToBookings" value="false" />
                                    <button type="submit" class="btn btn-secondary">
                                        <i class="fas fa-times me-2"></i>@Localizer["No"]
                                    </button>
                                </form>
                            </div>
                        </div>
                    }

                    <form asp-action="Edit" method="post">
                        <div asp-validation-summary="ModelOnly" class="alert alert-danger" role="alert"></div>

                        <input type="hidden" asp-for="Id" />
                        <input type="hidden" name="returnUrl" value="@ViewData["ReturnUrl"]" />

                        <div class="mb-3">
                            <label for="Name" class="form-label">@Localizer["Field.Name"]</label>
                            <input asp-for="Name" class="form-control" id="Name" />
                            <span asp-validation-for="Name" class="text-danger"></span>
                        </div>

                        <div class="mb-3">
                            <label for="Description" class="form-label">@Localizer["Field.Description"]</label>
                            <textarea asp-for="Description" class="form-control" rows="3" id="Description"></textarea>
                            <span asp-validation-for="Description" class="text-danger"></span>
                        </div>

                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label for="StartDate" class="form-label">@Localizer["Field.StartDate"]</label>
                                <input asp-for="StartDate" type="date" class="form-control" id="StartDate" />
                                <span asp-validation-for="StartDate" class="text-danger"></span>
                            </div>
                            <div class="col-md-6 mb-3">
                                <label for="EndDate" class="form-label">@Localizer["Field.EndDate"]</label>
                                <input asp-for="EndDate" type="date" class="form-control" id="EndDate" />
                                <span asp-validation-for="EndDate" class="text-danger"></span>
                            </div>
                        </div>

                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label for="PricePerDay" class="form-label">@Localizer["Field.PricePerDay"]</label>
                                <div class="input-group">
                                    <input asp-for="PricePerDay" type="text" class="form-control" id="PricePerDay"
                                           data-val-number="@Localizer["Validation.Number"]" />
                                    <span class="input-group-text">â‚¬</span>
                                </div>
                                <span asp-validation-for="PricePerDay" class="text-danger"></span>
                            </div>
                            <div class="col-md-6 mb-3 d-flex align-items-end">
                                <div class="form-check">
                                    <input asp-for="IsActive" class="form-check-input" id="IsActive" />
                                    <label for="IsActive" class="form-check-label">@Localizer["Field.IsActive"]</label>
                                </div>
                            </div>
                        </div>

                        <input type="hidden" asp-for="OrganisationId" />

                        <hr />

                        <h6 class="mb-3 text-primary"><i class="fas fa-map-marker-alt me-2"></i>@Localizer["Activities.PostalCodeRestrictions"]</h6>

                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label for="IncludedPostalCodes" class="form-label">@Localizer["Activities.IncludedPostalCodes"]</label>
                                <input asp-for="IncludedPostalCodes" class="form-control" id="IncludedPostalCodes" />
                                <span asp-validation-for="IncludedPostalCodes" class="text-danger"></span>
                                <small class="form-text text-muted">@Localizer["Activities.IncludedPostalCodesHelp"]</small>
                            </div>
                            <div class="col-md-6 mb-3">
                                <label for="ExcludedPostalCodes" class="form-label">@Localizer["Activities.ExcludedPostalCodes"]</label>
                                <input asp-for="ExcludedPostalCodes" class="form-control" id="ExcludedPostalCodes" />
                                <span asp-validation-for="ExcludedPostalCodes" class="text-danger"></span>
                                <small class="form-text text-muted">@Localizer["Activities.ExcludedPostalCodesHelp"]</small>
                            </div>
                        </div>

                        <hr />

                        <h6 class="mb-3 text-primary"><i class="fas fa-calendar-week me-2"></i>@Localizer["Activities.ManageDays"]</h6>

                        @if (Model.WeeklyDays.Any())
                        {
                            <div class="alert alert-info">
                                <i class="fas fa-info-circle me-2"></i>@Localizer["Activities.ManageDaysHelp"]
                            </div>

                            <div class="row g-3">
                                @foreach (var week in Model.WeeklyDays)
                                {
                                    <div class="col-md-6 col-lg-4">
                                        <div class="card h-100">
                                            <div class="card-header bg-light">
                                                <i class="fas fa-calendar me-2"></i>@week.WeekLabel
                                                <small class="text-muted ms-2">(@week.StartDate.ToString("dd/MM") - @week.EndDate.ToString("dd/MM/yyyy"))</small>
                                            </div>
                                            <div class="card-body p-0">
                                                <div class="list-group list-group-flush">
                                                    @foreach (var day in week.Days)
                                                    {
                                                        var dayName = day.DayOfWeek switch
                                                        {
                                                            DayOfWeek.Monday => Localizer["DayOfWeek.Monday"],
                                                            DayOfWeek.Tuesday => Localizer["DayOfWeek.Tuesday"],
                                                            DayOfWeek.Wednesday => Localizer["DayOfWeek.Wednesday"],
                                                            DayOfWeek.Thursday => Localizer["DayOfWeek.Thursday"],
                                                            DayOfWeek.Friday => Localizer["DayOfWeek.Friday"],
                                                            DayOfWeek.Saturday => Localizer["DayOfWeek.Saturday"],
                                                            DayOfWeek.Sunday => Localizer["DayOfWeek.Sunday"],
                                                            _ => ""
                                                        };
                                                        var bgClass = day.IsWeekend ? "bg-light" : "";

                                                        <div class="list-group-item @bgClass py-2">
                                                            <div class="form-check">
                                                                <input class="form-check-input" type="checkbox"
                                                                       name="ActiveDayIds" value="@day.DayId"
                                                                       id="day_@day.DayId" @(day.IsActive ? "checked" : "") />
                                                                <label class="form-check-label" for="day_@day.DayId">
                                                                    <strong>@dayName</strong>
                                                                    <small class="text-muted ms-1">@day.DayDate.ToString("dd/MM")</small>
                                                                    @if (day.IsWeekend)
                                                                    {
                                                                        <span class="badge bg-warning text-dark ms-1" style="font-size: 0.65rem;">Week-end</span>
                                                                    }
                                                                </label>
                                                            </div>
                                                        </div>
                                                    }
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                }
                            </div>
                        }

                        <hr />

                        <h6 class="mb-3 text-primary"><i class="fas fa-question-circle me-2"></i>@Localizer["Activities.ManageQuestions"]</h6>

                        <div class="alert alert-info">
                            <i class="fas fa-info-circle me-2"></i>@Localizer["Activities.DragToReorder"]
                        </div>

                        <div id="existingQuestionsList" class="mb-3">
                            @for (int i = 0; i < Model.ExistingQuestions.Count; i++)
                            {
                                var question = Model.ExistingQuestions[i];
                                <div class="card mb-2 question-item" data-question-id="@question.Id">
                                    <div class="card-body py-2">
                                        <input type="hidden" name="ExistingQuestions[@i].Id" value="@question.Id" />
                                        <input type="hidden" name="ExistingQuestions[@i].DisplayOrder" value="@question.DisplayOrder" class="display-order-input" />

                                        <div class="row g-2 align-items-center">
                                            <div class="col-auto">
                                                <i class="fas fa-grip-vertical drag-handle text-muted" style="cursor: move;"></i>
                                            </div>
                                            <div class="col-md-4">
                                                <input type="text" name="ExistingQuestions[@i].QuestionText" value="@question.QuestionText"
                                                       class="form-control form-control-sm" required maxlength="500" />
                                            </div>
                                            <div class="col-md-2">
                                                <select name="ExistingQuestions[@i].QuestionType" class="form-select form-select-sm question-type-select-edit"
                                                        data-question-index="@i" required>
                                                    <option value="0" selected="@(question.QuestionType == QuestionType.Text)">@Localizer["Enum.QuestionType.Text"]</option>
                                                    <option value="1" selected="@(question.QuestionType == QuestionType.Checkbox)">@Localizer["Enum.QuestionType.Checkbox"]</option>
                                                    <option value="2" selected="@(question.QuestionType == QuestionType.Radio)">@Localizer["Enum.QuestionType.Radio"]</option>
                                                    <option value="3" selected="@(question.QuestionType == QuestionType.Dropdown)">@Localizer["Enum.QuestionType.Dropdown"]</option>
                                                </select>
                                            </div>
                                            <div class="col-md-2">
                                                <div class="form-check form-switch">
                                                    <input type="checkbox" name="ExistingQuestions[@i].IsRequired" value="true"
                                                           class="form-check-input" id="existing_required_@i" checked="@question.IsRequired" />
                                                    <input type="hidden" name="ExistingQuestions[@i].IsRequired" value="false" />
                                                    <label class="form-check-label small" for="existing_required_@i">@Localizer["Required"]</label>
                                                </div>
                                            </div>
                                            <div class="col-md-2">
                                                <div class="form-check form-switch">
                                                    <input type="checkbox" name="ExistingQuestions[@i].IsActive" value="true"
                                                           class="form-check-input" id="existing_active_@i" checked="@question.IsActive" />
                                                    <input type="hidden" name="ExistingQuestions[@i].IsActive" value="false" />
                                                    <label class="form-check-label small" for="existing_active_@i">@Localizer["Active"]</label>
                                                </div>
                                            </div>
                                            <div class="col-12 question-options-container-edit" id="existing_options_@i"
                                                 style="display: @(question.QuestionType == QuestionType.Radio || question.QuestionType == QuestionType.Dropdown ? "block" : "none");">
                                                <input type="text" name="ExistingQuestions[@i].Options" value="@question.Options"
                                                       class="form-control form-control-sm" maxlength="1000"
                                                       placeholder="@Localizer["Activities.OptionsPlaceholder"]" />
                                                <small class="form-text text-muted">@Localizer["Activities.OptionsHelp"]</small>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            }
                        </div>

                        <div id="newQuestionsList"></div>

                        <button type="button" class="btn btn-sm btn-outline-primary mb-3" id="addNewQuestionBtn">
                            <i class="fas fa-plus me-2"></i>@Localizer["Activities.AddQuestion"]
                        </button>

                        <hr />

                        <div class="d-flex justify-content-between">
                            @{
                                var returnUrl = ViewData["ReturnUrl"]?.ToString();
                                var cancelUrl = !string.IsNullOrEmpty(returnUrl) ? returnUrl : Url.Action("Index");
                            }
                            <a href="@cancelUrl" class="btn btn-outline-secondary text-nowrap">
                                <i class="fas fa-arrow-left me-2"></i>@Localizer["Cancel"]
                            </a>
                            <button type="submit" class="btn btn-primary text-nowrap">
                                <i class="fas fa-save me-2"></i>@Localizer["Save"]
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <partial name="_ValidationScriptsPartial" />
    <script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.0/Sortable.min.js"></script>

    <script>
        $(document).ready(function() {
            // Initialize Choices.js on all selects
            CedevaChoices.initAll('.form-select');

            // Override jQuery Validation to accept comma as decimal separator (French format)
            if ($.validator) {
                // Override number validation to accept comma
                $.validator.methods.number = function(value, element) {
                    return this.optional(element) || /^-?(?:\d+|\d{1,3}(?:[\s\.,]\d{3})+)?(?:[,\.]\d+)?$/.test(value);
                };

                // Override range validation to convert comma to point
                $.validator.methods.range = function(value, element, param) {
                    var globalizedValue = value.replace(",", ".");
                    return this.optional(element) || (globalizedValue >= param[0] && globalizedValue <= param[1]);
                };

                // Set default French messages
                $.validator.messages.number = "Veuillez entrer un nombre valide.";
                $.validator.messages.range = "Veuillez entrer une valeur entre {0} et {1}.";

                // After unobtrusive validation parses, override element-specific messages
                setTimeout(function() {
                    var $priceField = $("#PricePerDay");
                    if ($priceField.length && $priceField.data("validator")) {
                        var validator = $priceField.closest("form").validate();
                        if (validator.settings.messages && validator.settings.messages.PricePerDay) {
                            if (validator.settings.messages.PricePerDay.number) {
                                validator.settings.messages.PricePerDay.number = "Veuillez entrer un nombre valide.";
                            }
                            if (validator.settings.messages.PricePerDay.range) {
                                validator.settings.messages.PricePerDay.range = $.validator.format("Veuillez entrer une valeur entre {0} et {1}.");
                            }
                        }
                    }
                }, 100);
            }

            // Initialize SortableJS for drag & drop
            var el = document.getElementById('existingQuestionsList');
            if (el) {
                var sortable = Sortable.create(el, {
                    handle: '.drag-handle',
                    animation: 150,
                    onEnd: function(evt) {
                        // Update DisplayOrder values after drag
                        $('#existingQuestionsList .question-item').each(function(index) {
                            $(this).find('.display-order-input').val(index + 1);
                        });
                    }
                });
            }

            // Show/hide options field based on question type (existing questions)
            $(document).on('change', '.question-type-select-edit', function() {
                const questionIdx = $(this).data('question-index');
                const selectedType = $(this).val();
                const optionsContainer = $('#existing_options_' + questionIdx);

                // Show options field for Radio (2) and Dropdown (3)
                if (selectedType === '2' || selectedType === '3') {
                    optionsContainer.show();
                } else {
                    optionsContainer.hide();
                    optionsContainer.find('input').val(''); // Clear options value
                }
            });

            // New questions management
            let newQuestionIndex = 0;

            $('#addNewQuestionBtn').on('click', function() {
                const questionHtml = `
                    <div class="card mb-2">
                        <div class="card-body py-2">
                            <div class="row g-2">
                                <div class="col-md-5">
                                    <input type="text" name="NewQuestions[\${newQuestionIndex}].QuestionText" class="form-control form-control-sm"
                                           placeholder="@Localizer["Activities.QuestionTextPlaceholder"]" required maxlength="500" />
                                </div>
                                <div class="col-md-3">
                                    <select name="NewQuestions[\${newQuestionIndex}].QuestionType" class="form-select form-select-sm question-type-select-new"
                                            data-question-index="\${newQuestionIndex}" required>
                                        <option value="">@Localizer["Activities.SelectQuestionType"]</option>
                                        <option value="0">@Localizer["Enum.QuestionType.Text"]</option>
                                        <option value="1">@Localizer["Enum.QuestionType.Checkbox"]</option>
                                        <option value="2">@Localizer["Enum.QuestionType.Radio"]</option>
                                        <option value="3">@Localizer["Enum.QuestionType.Dropdown"]</option>
                                    </select>
                                </div>
                                <div class="col-md-2">
                                    <div class="form-check">
                                        <input type="checkbox" name="NewQuestions[\${newQuestionIndex}].IsRequired" value="true"
                                               class="form-check-input" id="new_required_\${newQuestionIndex}" />
                                        <input type="hidden" name="NewQuestions[\${newQuestionIndex}].IsRequired" value="false" />
                                        <label class="form-check-label small" for="new_required_\${newQuestionIndex}">
                                            @Localizer["Required"]
                                        </label>
                                    </div>
                                </div>
                                <div class="col-md-2 text-end">
                                    <button type="button" class="btn btn-sm btn-outline-danger remove-new-question-btn">
                                        <i class="fas fa-trash"></i>
                                    </button>
                                </div>
                                <div class="col-12 question-options-container-new" id="new_options_\${newQuestionIndex}" style="display: none;">
                                    <input type="text" name="NewQuestions[\${newQuestionIndex}].Options" class="form-control form-control-sm"
                                           placeholder="@Localizer["Activities.OptionsPlaceholder"]" maxlength="1000" />
                                    <small class="form-text text-muted">@Localizer["Activities.OptionsHelp"]</small>
                                </div>
                            </div>
                        </div>
                    </div>`;

                $('#newQuestionsList').append(questionHtml);
                newQuestionIndex++;
            });

            $(document).on('click', '.remove-new-question-btn', function() {
                $(this).closest('.card').remove();
            });

            // Show/hide options field based on question type (new questions)
            $(document).on('change', '.question-type-select-new', function() {
                const questionIdx = $(this).data('question-index');
                const selectedType = $(this).val();
                const optionsContainer = $('#new_options_' + questionIdx);

                // Show options field for Radio (2) and Dropdown (3)
                if (selectedType === '2' || selectedType === '3') {
                    optionsContainer.show();
                } else {
                    optionsContainer.hide();
                    optionsContainer.find('input').val(''); // Clear options value
                }
            });
        });
    </script>
}
