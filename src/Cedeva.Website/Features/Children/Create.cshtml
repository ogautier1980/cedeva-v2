@model Cedeva.Website.Features.Children.ViewModels.ChildViewModel
@{
    ViewData["Title"] = Localizer["Children.AddChild"];
}

<div class="container-fluid">
    <div class="row">
        <div class="col-lg-8">
            <div class="card shadow">
                <div class="card-header">
                    <h5 class="mb-0"><i class="fas fa-child me-2"></i>@Localizer["Children.AddChild"]</h5>
                </div>
                <div class="card-body">
                    <form asp-action="Create" method="post">
                        <div asp-validation-summary="ModelOnly" class="alert alert-danger" role="alert"></div>

                        <h6 class="mb-3 text-primary"><i class="fas fa-user me-2"></i>@Localizer["Children.PersonalInformation"]</h6>

                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label for="FirstName" class="form-label">@Localizer["Field.FirstName"]</label>
                                <input asp-for="FirstName" class="form-control" id="FirstName" />
                                <span asp-validation-for="FirstName" class="text-danger"></span>
                            </div>
                            <div class="col-md-6 mb-3">
                                <label for="LastName" class="form-label">@Localizer["Field.LastName"]</label>
                                <input asp-for="LastName" class="form-control" id="LastName" />
                                <span asp-validation-for="LastName" class="text-danger"></span>
                            </div>
                        </div>

                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label for="NationalRegisterNumber" class="form-label">@Localizer["Field.NationalRegisterNumber"]</label>
                                <input asp-for="NationalRegisterNumber" class="form-control" placeholder="@Localizer["Children.NRNPlaceholder"]" id="NationalRegisterNumber" />
                                <span asp-validation-for="NationalRegisterNumber" class="text-danger"></span>
                            </div>
                            <div class="col-md-6 mb-3">
                                <label for="BirthDate" class="form-label">@Localizer["Field.BirthDate"]</label>
                                <input asp-for="BirthDate" type="date" class="form-control" id="BirthDate" />
                                <span asp-validation-for="BirthDate" class="text-danger"></span>
                            </div>
                        </div>

                        <h6 class="mb-3 mt-4 text-primary"><i class="fas fa-users me-2"></i>@Localizer["Parent"]</h6>

                        <div class="mb-3">
                            <label for="ParentId" class="form-label">@Localizer["Field.Parent"]</label>
                            <select asp-for="ParentId" class="form-select" asp-items="ViewBag.Parents" id="ParentId">
                                <option value="">@Localizer["Children.SelectParent"]</option>
                            </select>
                            <span asp-validation-for="ParentId" class="text-danger"></span>
                            <div class="form-text">
                                <button type="button" class="btn btn-link p-0 text-decoration-none" id="toggleParentForm">
                                    <i class="fas fa-plus-circle me-1"></i>@Localizer["Children.CreateNewParent"]
                                </button>
                            </div>
                        </div>

                        <!-- Inline Parent Creation Form -->
                        <div id="parentFormContainer" class="card border-primary mb-3" style="display: none;">
                            <div class="card-header bg-primary text-white">
                                <h6 class="mb-0"><i class="fas fa-user-plus me-2"></i>@Localizer["Parents.NewParent"]</h6>
                            </div>
                            <div class="card-body">
                                <div id="parentFormErrors" class="alert alert-danger" style="display: none;"></div>

                                <form id="parentForm">
                                    @Html.AntiForgeryToken()
                                    <input type="hidden" name="OrganisationId" value="@ViewBag.CurrentOrganisationId" />
                                    <input type="hidden" name="Country" value="0" />

                                    <h6 class="mb-3 text-primary"><i class="fas fa-user me-2"></i>@Localizer["PersonalInformation"]</h6>

                                    <div class="row">
                                        <div class="col-md-6 mb-3">
                                            <label for="Parent_FirstName" class="form-label">@Localizer["Field.FirstName"]</label>
                                            <input type="text" class="form-control" id="Parent_FirstName" name="FirstName" required />
                                            <span class="text-danger field-error" data-field="FirstName"></span>
                                        </div>
                                        <div class="col-md-6 mb-3">
                                            <label for="Parent_LastName" class="form-label">@Localizer["Field.LastName"]</label>
                                            <input type="text" class="form-control" id="Parent_LastName" name="LastName" required />
                                            <span class="text-danger field-error" data-field="LastName"></span>
                                        </div>
                                    </div>

                                    <div class="mb-3">
                                        <label for="Parent_NationalRegisterNumber" class="form-label">@Localizer["Field.NationalRegisterNumber"]</label>
                                        <input type="text" class="form-control" id="Parent_NationalRegisterNumber" name="NationalRegisterNumber" placeholder="@Localizer["Children.NRNPlaceholder"]" />
                                        <span class="text-danger field-error" data-field="NationalRegisterNumber"></span>
                                    </div>

                                    <h6 class="mb-3 text-primary"><i class="fas fa-phone me-2"></i>@Localizer["Contact"]</h6>

                                    <div class="mb-3">
                                        <label for="Parent_Email" class="form-label">@Localizer["Field.Email"]</label>
                                        <input type="email" class="form-control" id="Parent_Email" name="Email" required />
                                        <span class="text-danger field-error" data-field="Email"></span>
                                    </div>

                                    <div class="row">
                                        <div class="col-md-6 mb-3">
                                            <label for="Parent_MobilePhoneNumber" class="form-label">@Localizer["Field.MobilePhoneNumber"]</label>
                                            <input type="text" class="form-control" id="Parent_MobilePhoneNumber" name="MobilePhoneNumber" placeholder="@Localizer["Parents.MobilePlaceholder"]" />
                                            <span class="text-danger field-error" data-field="MobilePhoneNumber"></span>
                                        </div>
                                        <div class="col-md-6 mb-3">
                                            <label for="Parent_PhoneNumber" class="form-label">@Localizer["Field.PhoneNumber"]</label>
                                            <input type="text" class="form-control" id="Parent_PhoneNumber" name="PhoneNumber" placeholder="@Localizer["Parents.PhonePlaceholder"]" />
                                            <span class="text-danger field-error" data-field="PhoneNumber"></span>
                                        </div>
                                    </div>

                                    <h6 class="mb-3 text-primary"><i class="fas fa-map-marker-alt me-2"></i>@Localizer["Address"]</h6>

                                    <div class="mb-3">
                                        <label for="Parent_Street" class="form-label">@Localizer["Field.Street"]</label>
                                        <input type="text" class="form-control" id="Parent_Street" name="Street" placeholder="@Localizer["Parents.StreetPlaceholder"]" required />
                                        <span class="text-danger field-error" data-field="Street"></span>
                                    </div>

                                    <div class="mb-3">
                                        <label for="Parent_CombinedAddress" class="form-label">@Localizer["Field.PostalCodeCity"]</label>
                                        <input type="text" class="form-control" id="Parent_CombinedAddress" placeholder="@Localizer["Parents.PostalCodeCityPlaceholder"]" />
                                        <small class="form-text text-muted">@Localizer["Parents.PostalCodeCityHelp"]</small>
                                        <input type="hidden" name="PostalCode" id="Parent_PostalCode" />
                                        <input type="hidden" name="City" id="Parent_City" />
                                        <span class="text-danger field-error" data-field="PostalCode"></span>
                                        <span class="text-danger field-error" data-field="City"></span>
                                    </div>

                                    <div class="d-flex justify-content-end gap-2">
                                        <button type="button" class="btn btn-outline-secondary" id="cancelParentForm">
                                            <i class="fas fa-times me-1"></i>@Localizer["Cancel"]
                                        </button>
                                        <button type="submit" class="btn btn-primary">
                                            <i class="fas fa-save me-1"></i>@Localizer["Parents.CreateParent"]
                                        </button>
                                    </div>
                                </form>
                            </div>
                        </div>

                        <h6 class="mb-3 mt-4 text-primary"><i class="fas fa-info-circle me-2"></i>@Localizer["Children.SpecificInformation"]</h6>

                        <div class="row">
                            <div class="col-md-4 mb-3">
                                <div class="form-check">
                                    <input asp-for="IsDisadvantagedEnvironment" class="form-check-input" type="checkbox" id="IsDisadvantagedEnvironment" />
                                    <label for="IsDisadvantagedEnvironment" class="form-check-label">@Localizer["Field.IsDisadvantagedEnvironment"]</label>
                                </div>
                            </div>
                            <div class="col-md-4 mb-3">
                                <div class="form-check">
                                    <input asp-for="IsMildDisability" class="form-check-input" type="checkbox" id="IsMildDisability" />
                                    <label for="IsMildDisability" class="form-check-label">@Localizer["Field.IsMildDisability"]</label>
                                </div>
                            </div>
                            <div class="col-md-4 mb-3">
                                <div class="form-check">
                                    <input asp-for="IsSevereDisability" class="form-check-input" type="checkbox" id="IsSevereDisability" />
                                    <label for="IsSevereDisability" class="form-check-label">@Localizer["Field.IsSevereDisability"]</label>
                                </div>
                            </div>
                        </div>

                        <hr />

                        <div class="d-flex justify-content-between">
                            <a asp-action="Index" class="btn btn-outline-secondary text-nowrap">
                                <i class="fas fa-arrow-left me-2"></i>@Localizer["Cancel"]
                            </a>
                            <button type="submit" class="btn btn-primary text-nowrap">
                                <i class="fas fa-save me-2"></i>@Localizer["Save"]
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <partial name="_ValidationScriptsPartial" />
    <script src="~/js/belgian-municipality-validator.js"></script>
    <script src="~/js/unified-address-autocomplete.js"></script>

    <script>
        $(function () {
            // Initialize address autocomplete for parent form
            initializeUnifiedAddressAutocomplete("#Parent_CombinedAddress", "#Parent_PostalCode", "#Parent_City");

            // Toggle parent form visibility
            $('#toggleParentForm').on('click', function () {
                $('#parentFormContainer').slideToggle(300);
                $(this).find('i').toggleClass('fa-plus-circle fa-minus-circle');
            });

            // Cancel parent form
            $('#cancelParentForm').on('click', function () {
                $('#parentFormContainer').slideUp(300);
                $('#toggleParentForm').find('i').removeClass('fa-minus-circle').addClass('fa-plus-circle');
                $('#parentForm')[0].reset();
                clearParentFormErrors();
            });

            // Submit parent form via AJAX
            $('#parentForm').on('submit', function (e) {
                e.preventDefault();
                clearParentFormErrors();

                var formData = $(this).serialize();

                $.ajax({
                    url: '@Url.Action("CreateAjax", "Parents")',
                    type: 'POST',
                    data: formData,
                    success: function (response) {
                        if (response.success) {
                            // Add new parent to dropdown
                            $('#ParentId').append(
                                $('<option>', {
                                    value: response.parentId,
                                    text: response.parentName,
                                    selected: true
                                })
                            );

                            // Hide and reset form
                            $('#parentFormContainer').slideUp(300);
                            $('#toggleParentForm').find('i').removeClass('fa-minus-circle').addClass('fa-plus-circle');
                            $('#parentForm')[0].reset();

                            // Show success message
                            toastr.success(response.message || '@Localizer["Message.ParentCreated"]');
                        } else {
                            // Show validation errors
                            if (response.errors) {
                                displayParentFormErrors(response.errors);
                            } else if (response.message) {
                                $('#parentFormErrors').html(response.message).show();
                            }
                        }
                    },
                    error: function (xhr, status, error) {
                        $('#parentFormErrors').html('@Localizer["Error.UnexpectedError"]').show();
                        console.error('Error creating parent:', error);
                    }
                });
            });

            function displayParentFormErrors(errors) {
                var errorHtml = '<ul class="mb-0">';
                for (var field in errors) {
                    var fieldErrors = errors[field];
                    for (var i = 0; i < fieldErrors.length; i++) {
                        errorHtml += '<li>' + fieldErrors[i] + '</li>';

                        // Also show error next to field
                        var errorSpan = $('.field-error[data-field="' + field + '"]');
                        if (errorSpan.length > 0) {
                            errorSpan.text(fieldErrors[i]);
                        }
                    }
                }
                errorHtml += '</ul>';
                $('#parentFormErrors').html(errorHtml).show();
            }

            function clearParentFormErrors() {
                $('#parentFormErrors').hide().empty();
                $('.field-error').text('');
            }
        });
    </script>
}
